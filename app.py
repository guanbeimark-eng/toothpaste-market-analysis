import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# è®¾ç½®ç½‘é¡µé…ç½®
st.set_page_config(page_title="ç‰™è†å¸‚åœºæ•°æ®åˆ†æ", layout="wide")

st.title("ğŸ¦· çº³ç±³ç¾ŸåŸºç£·ç°çŸ³ç‰™è† - äºšé©¬é€Šå¸‚åœºåˆ†æ")
st.markdown("ä¸Šä¼  CSV æ–‡ä»¶ä»¥ç”Ÿæˆäº¤äº’å¼åˆ†ææŠ¥è¡¨")

# ä¾§è¾¹æ ä¸Šä¼ æ–‡ä»¶
st.sidebar.header("æ•°æ®ä¸Šä¼ åŒº")
uploaded_us_file = st.sidebar.file_uploader("ä¸Šä¼  US.csv (äº§å“æ˜ç»†)", type=["csv"])
uploaded_brand_file = st.sidebar.file_uploader("ä¸Šä¼  Brands.csv (å“ç‰Œæ±‡æ€»)", type=["csv"])

# æ•°æ®æ¸…æ´—è¾…åŠ©å‡½æ•°
def clean_currency(x):
    if isinstance(x, str):
        return float(x.replace('$', '').replace(',', '').replace(' ', ''))
    return x

# --- Tab 1: äº§å“åˆ†æ (åŸºäº US.csv) ---
if uploaded_us_file is not None:
    try:
        # è¯»å–æ•°æ®
        df_us = pd.read_csv(uploaded_us_file)
        
        # ç®€å•çš„æ•°æ®æ¸…æ´— (æ ¹æ®ä½ æä¾›çš„æ–‡ä»¶åˆ—å)
        # ç¡®ä¿å…³é”®æ•°å€¼åˆ—æ˜¯æ•°å­—ç±»å‹
        numeric_cols = ['æœˆé”€é‡', 'æœˆé”€å”®é¢($)', 'ä»·æ ¼($)', 'è¯„åˆ†', 'è¯„åˆ†æ•°']
        for col in numeric_cols:
            if col in df_us.columns:
                df_us[col] = df_us[col].apply(clean_currency)

        st.header("1. äº§å“ç»´åº¦åˆ†æ (Product Analysis)")
        
        # å…³é”®æŒ‡æ ‡å¡ç‰‡
        col1, col2, col3, col4 = st.columns(4)
        col1.metric("æ€»é”€å”®é¢", f"${df_us['æœˆé”€å”®é¢($)'].sum():,.0f}")
        col2.metric("æ€»é”€é‡", f"{df_us['æœˆé”€é‡'].sum():,.0f}")
        col3.metric("å¹³å‡ä»·æ ¼", f"${df_us['ä»·æ ¼($)'].mean():.2f}")
        col4.metric("å¹³å‡è¯„åˆ†", f"{df_us['è¯„åˆ†'].mean():.2f} â­")

        # å›¾è¡¨åŒº
        c1, c2 = st.columns(2)
        
        with c1:
            st.subheader("ä»·æ ¼åˆ†å¸ƒç›´æ–¹å›¾")
            fig_price = px.histogram(df_us, x="ä»·æ ¼($)", nbins=20, title="äº§å“ä»·æ ¼åˆ†å¸ƒåŒºé—´", color_discrete_sequence=['#36b9cc'])
            st.plotly_chart(fig_price, use_container_width=True)

        with c2:
            st.subheader("é”€é‡ vs è¯„åˆ†")
            fig_scatter = px.scatter(df_us, x="è¯„åˆ†", y="æœˆé”€é‡", size="ä»·æ ¼($)", 
                                     hover_data=['å“ç‰Œ', 'å•†å“æ ‡é¢˜'], color="è¯„åˆ†",
                                     title="è¯„åˆ†ä¸é”€é‡çš„å…³ç³» (æ°”æ³¡å¤§å°=ä»·æ ¼)")
            st.plotly_chart(fig_scatter, use_container_width=True)

        st.subheader("Top 10 ç•…é”€å•å“")
        st.dataframe(df_us[['å•†å“æ ‡é¢˜', 'å“ç‰Œ', 'ä»·æ ¼($)', 'æœˆé”€é‡', 'æœˆé”€å”®é¢($)', 'è¯„åˆ†']].sort_values(by='æœˆé”€é‡', ascending=False).head(10))

    except Exception as e:
        st.error(f"è§£æ US.csv æ–‡ä»¶æ—¶å‡ºé”™: {e}")
        st.info("è¯·ç¡®ä¿ä¸Šä¼ äº†æ­£ç¡®çš„æ–‡ä»¶æ ¼å¼ã€‚")

else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ ä¸Šä¼  '...US.csv' æ–‡ä»¶ä»¥æŸ¥çœ‹äº§å“åˆ†æã€‚")

st.divider()

# --- Tab 2: å“ç‰Œåˆ†æ (åŸºäº Brands.csv) ---
if uploaded_brand_file is not None:
    try:
        df_brand = pd.read_csv(uploaded_brand_file)
        
        # æ¸…æ´—æ•°æ®
        cols_to_clean = ['æœˆé”€é‡', 'æœˆé”€å”®é¢($)', 'å¹³å‡ä»·æ ¼($)', 'å¸‚åœºä»½é¢']
        for col in cols_to_clean:
            if col in df_brand.columns:
                df_brand[col] = df_brand[col].apply(clean_currency)

        st.header("2. å“ç‰Œç»´åº¦åˆ†æ (Brand Analysis)")

        # å¸ƒå±€
        b1, b2 = st.columns([2, 1])

        with b1:
            st.subheader("å„å“ç‰Œå¸‚åœºä»½é¢ (æŒ‰æœˆé”€å”®é¢)")
            # è¿‡æ»¤æ‰é”€å”®é¢æå°çš„å“ç‰Œä»¥ä¼˜åŒ–é¥¼å›¾æ˜¾ç¤º
            top_brands = df_brand.sort_values(by='æœˆé”€å”®é¢($)', ascending=False).head(15)
            fig_pie = px.pie(top_brands, values='æœˆé”€å”®é¢($)', names='å“ç‰Œ', title='Top 15 å“ç‰Œé”€å”®é¢å æ¯”', hole=0.4)
            st.plotly_chart(fig_pie, use_container_width=True)

        with b2:
            st.subheader("å“ç‰Œå‡ä»·å¯¹æ¯” (Top 10 é”€é‡å“ç‰Œ)")
            top_vol_brands = df_brand.sort_values(by='æœˆé”€é‡', ascending=False).head(10)
            fig_bar = px.bar(top_vol_brands, x='å“ç‰Œ', y='å¹³å‡ä»·æ ¼($)', title='å¤´éƒ¨å“ç‰Œå¹³å‡å•ä»·', color='å¹³å‡ä»·æ ¼($)')
            st.plotly_chart(fig_bar, use_container_width=True)

        st.subheader("å“ç‰Œè¯¦ç»†æ•°æ®è¡¨")
        st.dataframe(df_brand)

    except Exception as e:
        st.error(f"è§£æ Brands.csv æ–‡ä»¶æ—¶å‡ºé”™: {e}")
else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ ä¸Šä¼  '...Brands.csv' æ–‡ä»¶ä»¥æŸ¥çœ‹å“ç‰Œåˆ†æã€‚")

# é¡µè„š
st.markdown("---")
st.caption("æ•°æ®æ¥æº: ä¸Šä¼ çš„ CSV æ–‡ä»¶ | Generated by Streamlit")